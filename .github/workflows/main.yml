name: action

on:
  [ pull_request_target ]

env:
   cache-build-name: build-env

jobs:
  
  prep:
    runs-on: self-hosted
    steps:
      - name: Git clone 
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
      - name: Checkout tools repo
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          path: resources
      - name: Dict_prep
        run: |

      - name: Prep
        run: |
            echo -e "Dict Init------------\n"
            declare -A space_cringe
            space_cringe[1.]="1.Verilog.Adder"
            space_cringe[2.]="2. Arithmetic-logic unit"
            space_cringe[3.]="3. Register file and memory"
            space_cringe[4.]="4. Primitive programmable device"
            space_cringe[5.]="5. Main decoder"
            space_cringe[6.]="6. Datapath"
            space_cringe[7.]="7. Peripheral units"
            space_cringe[8.]="8. Programming"
            
            declare -A tb_dict
            #tb_dict["1.Verilog.Adder"]=tb_miriscv_adder.v
            tb_dict["2. Arithmetic-logic unit"]=tb_miriscv_alu.v
            tb_dict["3. Register file and memory"]=tb_miriscv_register_file.v
            #tb_dict["4. Primitive programmable device"]=tb_miriscv_dp.v
            tb_dict["5. Main decoder"]=tb_miriscv_decode.v
            tb_dict["6. Datapath"]=tb_miriscv_lsu.v
            tb_dict["7. Peripheral units"]=tb_miriscv_core.sv
            #tb_dict[]=tb_miriscv_cu.v
            #tb_dict[]=tb_miriscv_sp_ram.sv
            #tb_dict[]=tb_miriscv_top.sv
            echo ${space_cringe[$ch_lab]}
            echo -e "End of dict init--------------------------"
            
            echo -e "----------Start of diff-------------------"
            #diff -qr Labs/ resources/Labs/ || true
            
            diff -qr resources/Labs/ Labs/ | grep -E "Labs.*differ" | cut -d ' ' -f 2 | sort | uniq > tmp
            line_numb=$(cat tmp | wc -l)
            echo  "Number of uniq lines: $line_numb"
            if [[ $line_numb -eq 1 ]]; then
                    lab_numb=$(cat tmp | cut -d '/' -f 3 | cut -d '.' -f 1)
                    ch_lab=$(diff -qr resources/Labs/ Labs/ | grep -E "Labs.*differ" | cut -d ' ' -f 2 | cut -d '/' -f 3)
                    echo "Start checking with lab â„–$lab_numb...."
                    echo "ch_lab: |$ch_lab|"
                    mv resources/Labs/${space_cringe[$ch_lab]}/* build-env/;
                    cp -Rr ~/mpsis/miriscv_tb/tb/${tb_dict[${space_cringe[$ch_lab]}]} build-env/;
            elif [[ $line_numb -eq 0 ]]; then
                    echo "Changed lab not founds"
                    exit 1
            else
                    echo "One lab change = one pull request. Change found in two labs or more labs"
                    exit 1
            fi

            
            
            diff -qr .github/workflows/main.yml resources/.github/workflows/main.yml || true
            echo -e "----------End of diff-------------------"
            ls -la;
            cat .github/workflows/main.yml
            echo -e "----------------End of README.md -------------------------------------------- \n\n"
            cat resources/.github/workflows/main.yml
            echo -e "----------------End of README.md -------------------------------------------- \n\n"
            ls -la Labs
            mkdir build-env;
            mv resources/Labs/"1.Verilog.Adder"/* build-env/;
            cp -Rr ~/mpsis/miriscv_tb/tb/tb_miriscv_alu.v build-env/;
            ls -la resources/
            cd build-env
            ls -la
      - name: Build
        run: |
            cd build-env;
            #mv miriscv_tb/tb/tb_miriscv_alu.v /tmp;

 # test1:      
 #     needs: [prep]
 #     runs-on: self-hosted
 #     steps: 
 #     - name: Set current time 
 #       run: echo "curr_time=$(date +'%H-%M-%S_')" >> $GITHUB_ENV;      
 #     - name: Build
 #       run: | 
 #         rm -rf log;
 #         mkdir log;
 #         touch log/file_${{ github.job }};
 #     - name: Send_Artifact
 #       uses: actions/upload-artifact@v2
 #       with:
 #         name: ${{ env.curr_time }}_hackathon_log__${{ github.job }}
 #         path: ./log/file*
 #         retention-days: 1
